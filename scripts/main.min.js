document.addEventListener("DOMContentLoaded", function() {
    init();
});

var cache = {};
var localStorage = window.localStorage;
var opts = {
    maxSpeed: 200
};

function init() {
    cache.speed = document.getElementById("speed");
    localStorage.measure || (localStorage.measure = "kh");
    localStorage = localStorage;
    initBtnClickListeners();
    writeSpeed = function(e) {
        document.getElementById("unit").innerHTML = "km/h";
        var n = e.coords.speed;
        "kh" === localStorage.measure && (n = 60 * n * 60,
        n /= 1000);
        n = Math.round(n);
        cache.speed.innerHTML = n;
    };

    navigator.geolocation.watchPosition(function(e) {
        writeSpeed(e);
    }, function(e) {
        document.getElementById("speed").innerHTML = "";
        document.getElementById("error").innerHTML = "ERROR(" + e.code + "): " + e.message;
        document.getElementById("info").style.display = "block";
    }, {
        enableHighAccuracy: true,
        maximumAge: 0
    });
}

function initBtnClickListeners() {
    document.getElementById("kh").addEventListener("click", function(e) {
        localStorage.measure = e.target.id;
        localStorage = localStorage;
    });
}
